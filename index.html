<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>0</title>

    <meta name="description" content="Source code generated using layoutit.com">
    <meta name="author" content="LayoutIt!">

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <link href="css/font-awesome/font-awesome.css" rel="stylesheet">
</head>

<body>

    <div class="container-fluid">

        <div class="row">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">چاپ لیبل</a></li>
                        <!-- <li class="breadcrumb-item active" aria-current="page">Contact</li> -->
                    </ol>
                </nav>
            </div>
        </div>

        <div class="row">
            <div class="col-8">
                <div class="card">

                    <div id="accordion">

                        <div class="card">
                            <div class="card-header" id="headingOne">
                                <h5 class="mb-0">
                                    <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne"
                                        aria-expanded="true" aria-controls="collapseOne">
                                        تنظیمات بارکد
                                    </button>
                                </h5>
                            </div>

                            <div id="collapseOne" class="collapse" aria-labelledby="headingOne"
                                data-parent="#accordion">
                                <div class="card-body">
                                    <form id="config" action="app.php" method="POST">
                                        <table class="table text-right" dir="rtl">
                                            <thead>
                                                <tr>
                                                    <th width="27.5%">عنوان</th>
                                                    <th width="15%">مکان شروع</th>
                                                    <th width="15%">تعداد ارقام</th>
                                                    <th width="27.5%"></th>
                                                    <th width="15%"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr class="p-0">
                                                    <td>عنوان نرم افزار</td>
                                                    <td class="p-1" colspan="2">
                                                        <input type="text" min="0" class="form-control text-center"
                                                            name="AppTitle">
                                                    </td>
                                                    <td class="text-left"></td>
                                                    <td class=""></td>

                                                </tr>
                                                <tr class="p-0">
                                                    <td>
                                                        <label class="btn p-0 w-100 text-right">
                                                            <span class="btn btn-sm"
                                                                style="height: 20px;width: 20px; background-color: red;"></span>
                                                            <input type="checkbox" contorole hidden
                                                                data-name="staticCode_status" checked>
                                                            کد ثابت بارکد
                                                        </label>
                                                    </td>
                                                    <td class="p-1">
                                                        <input type="number" min="0" class="form-control text-center"
                                                            name="staticCode_start" value="1">
                                                    </td>
                                                    <td class="p-1">
                                                        <input type="number" min="0" class="form-control text-center"
                                                            name="staticCode_count" value="1">
                                                    </td>
                                                    <td class="text-left">
                                                        کد ثابت بارکد
                                                    </td>
                                                    <td class="">
                                                        <input type="number" min="0" value="1" name="staticCode_value"
                                                            class="form-control mx-2" />
                                                    </td>

                                                </tr>
                                                <tr class="p-0">
                                                    <td>
                                                        <label class="btn p-0 w-100 text-right">
                                                            <span class="btn btn-sm"
                                                                style="height: 20px;width: 20px; background-color: blue;"></span>
                                                            <input type="checkbox" contoroler checked
                                                                data-name="productcode_status">
                                                            کد کالا
                                                        </label>
                                                    </td>
                                                    <td class="p-1">
                                                        <input type="number" min="0" class="form-control text-center"
                                                            value="1" name="productcode_start">
                                                    </td>
                                                    <td class="p-1">
                                                        <input type="number" min="0" class="form-control text-center"
                                                            value="1" name="productcode_count">
                                                    </td>
                                                    <td class="text-left">
                                                        <!-- <input type="checkbox" disabled data-name="staticCode_value" class="mx-2" /> -->
                                                        <!-- کد ثابت کالا -->
                                                    </td>
                                                    <td class="">
                                                        <!-- <input type="number"min="0" value="1" name="staticCode_value" class="form-control mx-2" disabled /> -->
                                                    </td>
                                                </tr>
                                                <tr class="p-0">
                                                    <td>
                                                        <label class="btn p-0 w-100 text-right">
                                                            <span class="btn btn-sm"
                                                                style="height: 20px;width: 20px; background-color: green;"></span>
                                                            <input type="checkbox" contoroler data-name="Price_status">
                                                            قیمت
                                                        </label>
                                                    </td>
                                                    <td class="p-1">
                                                        <input type="number" min="0" class="form-control text-center"
                                                            readonly value="1" name="Price_start">
                                                    </td>
                                                    <td class="p-1">
                                                        <input type="number" min="0" class="form-control text-center"
                                                            readonly value="1" name="Price_count">
                                                    </td>
                                                    <td class="p-1"></td>
                                                    <td class="p-1"></td>
                                                </tr>
                                                <tr class="p-0">
                                                    <td>
                                                        <label class="btn p-0 w-100 text-right">
                                                            <span class="btn btn-sm"
                                                                style="height: 20px;width: 20px; background-color: yellow;"></span>
                                                            <input type="checkbox" contoroler checked
                                                                data-name="Weight_status">
                                                            وزن/مقدار
                                                        </label>
                                                    </td>
                                                    <td class="p-1">
                                                        <input type="number" min="0" class="form-control text-center"
                                                            value="1" name="Weight_start">
                                                    </td>
                                                    <td class="p-1">
                                                        <input type="number" min="0" class="form-control text-center"
                                                            value="1" name="Weight_count">
                                                    </td>
                                                    <td class="text-left">
                                                        ضرب در
                                                    </td>
                                                    <td class="">
                                                        <input type="number" name="Weight_ToGram"
                                                            class="form-control text-center" />
                                                    </td>
                                                </tr>
                                                <tr class="p-0">
                                                    <td>
                                                        <label class="btn p-0 w-100 text-right">
                                                            <span class="btn btn-sm"
                                                                style="height: 20px;width: 20px; background-color: pink;"></span>
                                                            <input type="checkbox" contoroler checked
                                                                data-name="Scalecode_status">
                                                            ترازو/ انبار
                                                        </label>
                                                    </td>
                                                    <td class="p-1">
                                                        <input type="number" min="0" class="form-control text-center"
                                                            value="1" name="Scalecode_start">
                                                    </td>
                                                    <td class="p-1">
                                                        <input type="number" min="0" class="form-control text-center"
                                                            value="1" name="Scalecode_count">
                                                    </td>
                                                    <td class="text-left">
                                                        مقدار پیشفرض
                                                    </td>
                                                    <td class="">
                                                        <input type="number" name="Scalecode_value"
                                                            class="form-control text-center" />
                                                    </td>
                                                </tr>
                                                <!-- <tr class="p-0">
                                                    <td>
                                                        <label class="btn p-0 w-100 text-right">
                                                            <span class="btn btn-sm"
                                                                style="height: 20px;width: 20px; background-color: gray;"></span>
                                                            <input type="checkbox" contoroler checked
                                                                data-name="ControlNumber_status">
                                                            رقم کنترل
                                                        </label>
                                                    </td>
                                                    <td class="p-1">
                                                        <input type="number" min="0" class="form-control text-center"
                                                            value="1" name="ControlNumber_start">
                                                    </td>
                                                    <td class="p-1">
                                                        <input type="number" min="0" class="form-control text-center"
                                                            value="1" name="ControlNumber_count">
                                                    </td>
                                                    <td class="p-1"></td>
                                                    <td class="p-1">
                                                        <button class="btn btn-sm btn-success btn-block"
                                                            id="submitForm"><i class="fa fa-save"></i></button>
                                                    </td>
                                                </tr> -->
                                            </tbody>
                                        </table>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header" id="headingTwo">
                                <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseTwo"
                                    aria-expanded="false" aria-controls="collapseTwo">
                                    محصولات
                                </button>
                                <label class="btn btn-sm btn-success float-left">
                                    بروزرسانی محصولات
                                    <input class="d-none" type="file" id="fileUpload"
                                        accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                                        onchange="Upload()" />
                                </label>
                            </div>

                            <div id="collapseTwo" class="collapse show" aria-labelledby="headingTwo"
                                data-parent="#accordion">
                                <div class="card-body">
                                    <table class="table table-hover forceWidth" id="barcodeData">
                                        <thead></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>

                        </div>

                    </div>

                </div>
            </div>

            <div class="col-4 col-sm-4">
                <div class="card bg-light mb-3">
                    <div class="card-header bg-success text-white text-uppercase"><i class="fa fa-barcode"></i> بارکد
                    </div>
                    <div class="card-body p-2">

                        <table class="table" id="lablePrint">
                            <thead></thead>

                            <tfoot>
                                <tr>
                                    <th class="text-center" colspan="2"><img id="barcode5" /></th>
                                </tr>
                            </tfoot>
                        </table>

                    </div>
                </div>
            </div>
        </div>




    </div>


    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/scripts.js"></script>
    <script src="js/barcode/JsBarcode.all.js"></script>
    <script type="text/javascript" src="js/xlsx.full.min.js"></script>

    <link href="js/DataTables/datatables.min.css" rel="stylesheet">
    <script src="js/DataTables/datatables.min.js"></script>
    <script type="text/javascript" src="js/printThis/printThis.js"></script>

    <script>
        var conf = [];
        var thead = $('<tr></tr>');
        var tbody = $('<tr></tr>');
        var lablePrintHtml = '';
        $.getJSON("DATA.json?ver=" + Math.random(), function (data) {
            conf = data;

            // console.log(conf);
            $.each(data, function (key, val) {
                if ($(`[name=${key}]`).is("[type=number]")) {
                    $(`[name='${key}'][type=number]`).val(val);
                } else if ($(`[name=${key}]`).is("[type=text]")) {
                    $(`[name='${key}'][type=text]`).val(val);
                } else if ($(`[data-name=${key}]`).is("[type=checkbox]")) {
                    if (val == 1) {
                        $(`[data-name='${key}'][type=checkbox]`).prop("checked", true).change();

                        if (key == "productcode_status") {
                            $(thead).append(`<th class="p-0 filterboxrow productcodeBase">${tit = $(`[data-name='${key}'][type=checkbox]`).closest("label").text().trim()}</th>`);
                            $(tbody).append(`<td class="productcode_status text-center p-0"><input type="hidden" data-barcode="${key}" class="w-100 text-center" value="1" min="0" maxlength="${data[key.replace("status", "count")]}"></td>`);

                            $(thead).append(`<th class="p-0 filterboxrow" width="50%">عنوان کالا</th>`);
                            $(tbody).append(`<td class="productcode_title px-1 py-0">عنوان کالا</td>`);

                            lablePrintHtml += `<tr>
                                <th width="50%" class="text-center productCode">-----</th>
                                <th width="50%" class="text-center"> : ITEM NO</th>
                                </tr>`;
                            lablePrintHtml += `<tr>
                                <th width="50%" class="text-center productTitle">-----</th>
                                <th width="50%" class="text-center"> : TITLE</th>
                                </tr>`;
                        }
                        if (key == "Price_status") {
                            $(thead).append(`<th>${tit = $(`[data-name='${key}'][type=checkbox]`).closest("label").text().trim()}</th>`);
                            $(tbody).append(`<td class="Price_status p-0"><input type="text" data-barcode="${key}" class="w-100 text-center" value="1" min="0" maxlength="${data[key.replace("status", "count")]}"></td>`);

                            lablePrintHtml += `<tr>
                                <th width="50%" class="text-center productPrice">-----</th>
                                <th width="50%" class="text-center"> : PRICE</th>
                                </tr>`;
                        }
                        if (key == "Weight_status") {
                            $(thead).append(`<th>${tit = $(`[data-name='${key}'][type=checkbox]`).closest("label").text().trim()}</th>`);
                            $(tbody).append(`<td class="Weight_status p-0"><input type="text" data-barcode="${key}" class="w-100 text-center" value="1" min="0" Realmaxlength="${data[key.replace("status", "count")]}" maxlength="${data[key.replace("status", "count")] - (String(data.Weight_ToGram).length - 1)}"></td>`);

                            lablePrintHtml += `<tr>
                                <th width="50%" class="text-center productWeight">-----</th>
                                <th width="50%" class="text-center"> : MTRS</th>
                                </tr>`;
                        }
                        // if (key == "Scalecode_status") {
                        //     $(thead).append(`<th>${tit = $(`[data-name='${key}'][type=checkbox]`).closest("label").text().trim()}</th>`);
                        //     $(tbody).append(`<td class="Scalecode_status p-0"><input type="text" data-barcode="${key}" class="w-100 text-center" value="${data.Scalecode_value}" min="0" maxlength="${data[key.replace("status", "count")]}"></td>`);
                        // }
                        // if (key == "ControlNumber_status") {
                        //     $(thead).append(`<th>${tit = $(`[data-name='${key}'][type=checkbox]`).closest("label").text().trim()}</th>`);
                        //     $(tbody).append(`<td class="ControlNumber_status p-0"><input type="text" data-barcode="${key}" class="w-100 text-center" value="1" min="0" maxlength="${data[key.replace("status", "count")]}"></td>`);
                        // }

                    } else {
                        $(`[data-name='${key}'][type=checkbox]`).prop("checked", false).change();
                    }
                }
            });

            $(thead).append(`<th width="1%"></th>`);
            $(tbody).append(`<td class="text-center"><button class="btn btn-sm btn-success btn-sm printThis" type="button"><i class="fa fa-print"></i></button></td>`);

            $("#barcodeData thead").append(thead);
            $("#lablePrint thead").append(`<tr><th colspan="2" class="text-center"><h1>${data.AppTitle}</h1></th></tr>`).append(lablePrintHtml);
        });

        $(document).on("click", "#barcodeData tbody tr", function (e) {
            $(this).find("td").each(function () {
                if ($(this).find("input[type=text]").length) {
                    $(this).find("input[type=text]").select().focus();
                    return false;
                }
            });
        });

        var repeat5 = function (text) {
            JsBarcode("#barcode5", text, {
                displayValue: true,
                fontSize: 20
            });
        };

        function printBarcode(that) {
            $("#lablePrint").printThis();
        }
        $(document).on("click", ".printThis", function (e) {
            printBarcode($(this));
        });
        $(document).on("keyup , focus", "#barcodeData tbody input", function (e) {
            var id = $(this).closest("tr").attr("id");
            // console.log(e.keyCode);
            if (e.keyCode == 13) {
                $(this).closest("td").next("td").find("[data-barcode]").select().focus();
                if ($(this).closest("td").next("td").find(".printThis").length) {
                    printBarcode($(this));
                }
                else if (!$(this).closest("td").next("td").find("[data-barcode]").length) {
                    $(this).closest("td").next("td").next("td").find("[data-barcode]").select().focus();
                }
            } else if (e.keyCode == 38) {
                $(this).closest("tr").prev("tr").find("td").find("[data-barcode]:first-child").select().focus();
            } else if (e.keyCode == 40) {
                $(this).closest("tr").next("tr").find("td").find("[data-barcode]:first-child").select().focus();
            }

            var val = conf.staticCode_value;
            $(this).closest("tr").find("[data-barcode]").each(function () {
                var max = $(this).attr("realmaxlength") || $(this).attr("maxlength");
                var v = $(this).val().replace(/ /g, '+').trim() || "0".repeat(max);
                if ($(this).attr("data-barcode") == "Weight_status") {
                    v = v * conf.Weight_ToGram;
                }
                v = String(v);
                if (max > v.length) {
                    v = "0".repeat(max - v.length) + v;
                }
                val += v;
            });
            val += conf.Scalecode_value;
            $("#lablePrint thead .productCode").text(EXCEL[id]['شناسه'] || '------');
            $("#lablePrint thead .productTitle").text(EXCEL[id]['عنوان'] || '------');
            $("#lablePrint thead .productPrice").text($(this).closest("tr").find("[data-barcode='Price_status']").val());
            $("#lablePrint thead .productWeight").text($(this).closest("tr").find("[data-barcode='Weight_status']").val());

            repeat5(val);
            // if ($(this).attr("maxlength") == $(this).val().length) {
            //     $(this).closest("td").next("td").find("[data-barcode]").val("").focus();
            // }
        });


        var change = (X) => {
            if ($(X).is(":checked")) {
                $(X).next("input").val(1);
                $(X).closest("tr").find("input[type=number]").prop("readonly", false); //.val(0);
                $(X).closest("tr").find("input[type=checkbox]").not(X).removeAttr("checked").prop("disabled", false); //.val(0);
            } else {
                $(X).next("input").val(0);
                $(X).closest("tr").find("input[type=number]").prop("readonly", true); //.val(0);
                $(X).closest("tr").find("input[type=checkbox]").not(X).removeAttr("checked").prop("disabled", true).val(0);
            }
        };
        $(document).on("change", "[type=number]", function () {
            if ($(this).val() < 0) $(this).val($(this).val() * -1);
        });
        $(document).find("[type=checkbox]").each(function () {
            var name = $(this).attr("data-name");
            var val = $(this).is(":checked") * 1;
            $(this).after(`<input type="hidden" name="${name}" value="${val}" />`);
            // if ($(this).is("[contoroler]")) change($(this));
        });
        $(document).on("change", "[contoroler]", function () {
            change($(this));
        });


        function Upload() {
            const fileUpload = (document.getElementById('fileUpload'));
            const regex = /^([a-zA-Z0-9\s_\\.\-:])+(.xls|.xlsx)$/;
            if (regex.test(fileUpload.value.toLowerCase())) {
                let fileName = fileUpload.files[0].name;
                if (typeof (FileReader) !== 'undefined') {
                    const reader = new FileReader();
                    if (reader.readAsBinaryString) {
                        reader.onload = (e) => {
                            processExcel(reader.result);
                        };
                        reader.readAsBinaryString(fileUpload.files[0]);
                    }
                } else {
                    console.log("This browser does not support HTML5.");
                }
            } else {
                console.log("Please upload a valid Excel file.");
            }
        }

        function processExcel(data) {
            const workbook = XLSX.read(data, { type: 'binary' });
            const firstSheet = workbook.SheetNames[0];
            const excelRows = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[firstSheet]);

            // console.log(excelRows);
            senddat(excelRows);
        }

        var senddat = (ExcelData) => {
            $("#loading").removeClass('d-none');
            $.ajax({
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="Bootstrap-keyword"]').attr('content')
                },
                type: "POST",
                url: "app.php",
                async: true,
                data: { ExcelData },
                cache: false,
                // contentType: false,
                // processData: false,
                // timeout: 60000,
                success: function (data) {
                    $("#loading").addClass('d-none');
                    // console.log(data);
                    location.reload();
                },
                error: function (data) {
                    $("#loading").addClass('d-none');
                    // console.log(data);
                    location.reload();
                },
            });
        }


        var EXCEL;
        $(document).ready(function () {
            $.getJSON("EXCEL.json?ver=" + Math.random(), function (data) {
                EXCEL = data;
                $.each(data, function (key, val) {
                    var clon = $(tbody).clone(true);

                    clon.prop("id", key);
                    clon.find("td.productcode_status").append(val['شناسه']).find("[data-barcode='productcode_status']").val(val['شناسه']);
                    clon.find("td.productcode_title").text(val['عنوان']);

                    $("#barcodeData tbody").append(clon);
                });

                table = new DataTable('#barcodeData', {
                    language: {
                        url: 'js/DataTables/fa.json'
                    },
                    autoWidth: false,
                    ordering: false,
                    // dom: 'rtip',
                    // searching: true,

                    info: false,
                    paging: false,
                    scrollCollapse: true,
                    scrollY: '400px',

                });
                // new $.fn.dataTable.FixedHeader(table);

                $('#barcodeData thead tr th.filterboxrow').each(function () {

                    var title = $(this).eq($(this).index()).text();

                    $(this).append('<input id="input' + $(this).index() + '" type="text" class="form-control text-center" placeholder="' + title + '" />').css('padding-left', '4px');

                    $(this).on('keyup change', function () {
                        table.column($(this).index()).search($('#input' + $(this).index()).val()).draw();
                    });
                });


            });

        });
        let table;


    </script>


</body>

</html>